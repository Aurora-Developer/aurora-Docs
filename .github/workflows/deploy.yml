name: Build and Deploy  # 工作流名称
on:
  push:  # 当代码被推送到仓库时触发工作流
    branches:
      - main  # 只在推送到 main 分支时触发

jobs:
  build:
    runs-on: ubuntu-latest  # 使用最新的 Ubuntu 环境运行

    steps:
    - name: Checkout code  # 检出代码
      uses: actions/checkout@v4  # 使用 checkout 操作拉取代码

    - name: Setup Node.js  # 设置 Node.js 环境
      uses: actions/setup-node@v2
      with:
        node-version: '22'  # 设置 Node.js 版本赖

    - name: Install pnpm  # 安装 pnpm
      run: npm install -g pnpm  # 使用 npm 安装 pnpm

    - name: Install dependencies
      run: pnpm install  # 使用 pnpm 安装所有依赖

    - name: Build project  # 构建项目
      run: pnpm run docs:build  # 使用 pnpm 构建项目

    - name: Upload build files to server  # 上传构建文件到服务器
      uses: moonpathbg/scp_uploader@latest
      with:
        host: ${{ secrets.SERVER_IP }}         # 远程服务器 IP 地址
        username: chenskiro                    # 远程服务器登录用户名
        key: ${{ secrets.DEPLOY_KEY }}         # 用于 SSH 的私钥
        source: .vitepress/dist                # 构建输出的本地目录
        target: /www/wwwroot/doc               # 远程服务器目标目录
